name: Deploy Server to EC2

on:
  workflow_dispatch:
  push:
    branches:
      - main

env:
  APP_NAME: trading-server-api
  BINARY_NAME: server-api
  SERVICE_NAME: trading-server-api

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build application
        working-directory: ./server
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o ${{ env.BINARY_NAME }} ./cmd/api

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}
          path: ./server/${{ env.BINARY_NAME }}
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem

          # Configure SSH with RSA key and skip host key verification for CI
          cat > ~/.ssh/config << EOF
          Host *
            IdentityFile ~/.ssh/ec2_key.pem
            IdentitiesOnly yes
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            PubkeyAcceptedKeyTypes +ssh-rsa
            HostKeyAlgorithms +ssh-rsa
          EOF
          chmod 600 ~/.ssh/config

      - name: Stop existing service
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "sudo systemctl stop ${{ env.SERVICE_NAME }} || true"

      - name: Deploy binary to EC2
        run: |
          chmod +x ${{ env.BINARY_NAME }}
          scp -i ~/.ssh/ec2_key.pem ${{ env.BINARY_NAME }} \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/${{ env.BINARY_NAME }}

          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'DEPLOY_SCRIPT'
            sudo mv /tmp/${{ env.BINARY_NAME }} /usr/local/bin/${{ env.BINARY_NAME }}
            sudo chmod +x /usr/local/bin/${{ env.BINARY_NAME }}
          DEPLOY_SCRIPT

      - name: Deploy AWS RDS certificate
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'CERT_SCRIPT'
            sudo mkdir -p /etc/ssl/certs
            sudo curl -sS https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem \
              -o /etc/ssl/certs/rds-ca-bundle.pem
            sudo chmod 644 /etc/ssl/certs/rds-ca-bundle.pem
          CERT_SCRIPT

      - name: Checkout code for migrations
        uses: actions/checkout@v4
        with:
          sparse-checkout: |
            server/db/migrations

      - name: Deploy environment variables
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo mkdir -p /etc/${{ env.SERVICE_NAME }}"

          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo tee /etc/${{ env.SERVICE_NAME }}/config.env > /dev/null" << EOF
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          POSTGRES_DB=${{ secrets.POSTGRES_DB }}
          POSTGRES_USER=${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
          GOOSE_DRIVER=${{ secrets.GOOSE_DRIVER }}
          GOOSE_DBSTRING=${{ secrets.GOOSE_DBSTRING }}
          GOOSE_MIGRATION_DIR=${{ secrets.GOOSE_MIGRATION_DIR }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          CRYPTO_KEY=${{ secrets.CRYPTO_KEY }}
          RDS_CA_BUNDLE=/etc/ssl/certs/rds-ca-bundle.pem
          EOF

          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo chmod 600 /etc/${{ env.SERVICE_NAME }}/config.env"

      - name: Run database migrations
        run: |
          # Upload migration files to EC2
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ~/migrations"
          scp -i ~/.ssh/ec2_key.pem -r server/db/migrations/* \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/migrations/

          # Install goose if not present
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'INSTALL_SCRIPT'
            if ! command -v goose &> /dev/null; then
              echo "Installing goose..."
              GOOSE_VERSION="v3.24.1"
              curl -fsSL "https://github.com/pressly/goose/releases/download/${GOOSE_VERSION}/goose_linux_x86_64" -o /tmp/goose
              sudo mv /tmp/goose /usr/local/bin/goose
              sudo chmod +x /usr/local/bin/goose
            fi
            echo "Goose version: $(goose --version)"
          INSTALL_SCRIPT

          # Run migrations
          echo "Running database migrations..."
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "goose -dir ~/migrations postgres '${{ secrets.DATABASE_URL }}' up"

          echo "Migration status:"
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "goose -dir ~/migrations postgres '${{ secrets.DATABASE_URL }}' status"

          # Cleanup migration files
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "rm -rf ~/migrations"

      - name: Setup systemd service
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo tee /etc/systemd/system/${{ env.SERVICE_NAME }}.service > /dev/null" << EOF
          [Unit]
          Description=Trading Tournament Server
          After=network.target

          [Service]
          Type=simple
          User=root
          WorkingDirectory=/usr/local/bin
          ExecStart=/usr/local/bin/${{ env.BINARY_NAME }}
          EnvironmentFile=/etc/${{ env.SERVICE_NAME }}/config.env
          Restart=always
          RestartSec=5
          StandardOutput=journal
          StandardError=journal

          [Install]
          WantedBy=multi-user.target
          EOF

          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "sudo systemctl daemon-reload && sudo systemctl enable ${{ env.SERVICE_NAME }}"

      - name: Start service
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "sudo systemctl start ${{ env.SERVICE_NAME }}"

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'VERIFY_SCRIPT'
            echo "Service status:"
            sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager
            echo ""
            echo "Recent logs:"
            sudo journalctl -u ${{ env.SERVICE_NAME }} -n 20 --no-pager
          VERIFY_SCRIPT

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/ec2_key.pem ~/.ssh/config
